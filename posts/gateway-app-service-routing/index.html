<!doctype html><html lang=en><head><title>Azure App Service routing using Application Gateway — Jannik Lassahn</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Use Azure Application Gateway to give multiple App Services the same domain and route between them using path based rules"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://janniklassahn.com/posts/gateway-app-service-routing/><link rel=stylesheet href=https://janniklassahn.com/assets/style.css><link rel=stylesheet href=https://janniklassahn.com/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://janniklassahn.com/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://janniklassahn.com/img/favicon.png><link href=https://janniklassahn.com/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://janniklassahn.com/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://janniklassahn.com/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://janniklassahn.com/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://janniklassahn.com/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://janniklassahn.com/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="Azure App Service routing using Application Gateway"><meta name=twitter:description content="Use Azure Application Gateway to give multiple App Services the same domain and route between them using path based rules"><meta property="og:title" content="Azure App Service routing using Application Gateway"><meta property="og:description" content="Use Azure Application Gateway to give multiple App Services the same domain and route between them using path based rules"><meta property="og:type" content="article"><meta property="og:url" content="https://janniklassahn.com/posts/gateway-app-service-routing/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-26T00:00:00+00:00"><meta property="article:modified_time" content="2023-08-26T00:00:00+00:00"><style>body.dark-theme{--color:#dadadb}</style></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__text>Jannik Lassahn</span></a>
<span class=header__right><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>Azure App Service routing using Application Gateway</h1><div class=post-meta><span class=post-date>26. Aug 2023</span></div><span class=post-tags><a href=https://janniklassahn.com/tags/azure/>#Azure</a>&nbsp;
<a href=https://janniklassahn.com/tags/app-service/>#App Service</a>&nbsp;
<a href=https://janniklassahn.com/tags/application-gateway/>#Application Gateway</a>&nbsp;</span><div class=post-content><p>Requirement:</p><p>have multiple App Services accessible on the <strong>same domain</strong>, but <strong>different URL paths</strong>.</p><p>Solution:</p><p>since one cannot bind the same custom domain to multiple App Services, we use Azure Application Gateway to handle all requests to the custom domain and configure path rules to route to respective App Services.</p><p><object id=gw-overview data=/img/appservice-appgw/gw-overview.svg style=max-width:100%;display:block></object></p><script>let svg;const observer=new MutationObserver(e=>{e.forEach(e=>{e.type==="attributes"&&e.attributeName==="class"&&svg.classList.toggle("dark-theme",document.body.classList.contains("dark-theme"))})}),obj=document.getElementById("gw-overview");obj.addEventListener("load",()=>{svg=obj.contentDocument.rootElement,document.body.classList.contains("dark-theme")&&svg.classList.add("dark-theme"),observer.observe(document.body,{attributes:!0})})</script><h2 id=example-setup>Example setup</h2><p>The following example shows how to configure the solution in detail. In addition to the App Services seen above, we&rsquo;ll have an App Service for handling remaining traffic; consider it a &ldquo;fallback&rdquo; route.</p><h3 id=prerequisites>Prerequisites</h3><ul><li>3 App Services<ul><li>&ldquo;Service A&rdquo; (gw-service-a.azurewebsites.net)</li><li>&ldquo;Service B&rdquo; (gw-service-b.azurewebsites.net)</li><li>&ldquo;Service Default&rdquo; (gw-service-default.azurewebsites.net)</li></ul></li><li>custom domain and respective PFX certificate</li></ul><h3 id=create-application-gateway>Create Application Gateway</h3><p>When creating the gateway, you&rsquo;ll have to go through an initial step-by-step wizard.
Make sure to fill out the &ldquo;Basics&rdquo; tab according to your requirements and add a public IP address in the &ldquo;Frontends&rdquo; tab.</p><blockquote><p>Please read the <a href=https://learn.microsoft.com/en-us/azure/application-gateway/>documention</a> for more information about various concepts/abstractions of App Gateway.</p></blockquote><h4 id=backend-pools>Backend pools</h4><p>In the &ldquo;Backends&rdquo; tab add a backend pool for each App Service. The following screenshot shows the pool for App Service &ldquo;A&rdquo;.</p><p><img src=/img/appservice-appgw/gw-add-backend-pool.jpeg alt="Backend pool"></p><h4 id=rules>Rules</h4><p>Moving on to the &ldquo;Configuration&rdquo; tab, we have to connect the frontend and backend.
Click on &ldquo;Add routing rule&rdquo; to open the rule form. It might be overwhelming at first, since it is not only used to add rules, but listeners and backend settings as well.</p><p><img src=/img/appservice-appgw/gw-add-https-rule.jpeg alt=Rule></p><p>For now, we&rsquo;ll setup the gateway to handle HTTPS traffic and route it to the backend pools.
If you don&rsquo;t want to setup HTTPS in the gateway, remember to disable HTTPS redirection in the App Services.</p><ul><li>choose any name and priority</li><li>in the &ldquo;Listener&rdquo; tab<ul><li>set protocol to HTTPS</li><li>upload a certificate for the desired domain and enter the password</li></ul></li><li>in the &ldquo;Backend targets&rdquo; tab<ul><li>set backend target to the &ldquo;fallback&rdquo; backend pool</li><li>click &ldquo;Add new backend settings&rdquo;</li></ul></li></ul><h5 id=rules---add-backend-settings>Rules -> Add backend settings</h5><p>The backend settings contain the most important settings when using App Services:</p><p><img src=/img/appservice-appgw/gw-add-backend-settings.jpg alt=Rule></p><p><strong>Override backend path</strong> changes the path that the App Service receives. If you leave it blank your application must be able to handle the same base path that the gateway uses, otherwise you&rsquo;ll always receive a 404 status code.</p><p>For example: a request to <em>domain.com/service-a/123</em> is proxied to &ldquo;Service A&rdquo; as <em>gw-service-a.azurewebsites.com/service-a/123</em>. How do you account for the additional path? You could map it in App Service directly using <a href="https://learn.microsoft.com/en-us/azure/app-service/configure-common?tabs=portal#map-a-url-path-to-a-directory">virtual paths</a> or let your server handle it, e.g. in ASP.NET Core by calling <code>app.UsePathBase</code>.</p><p>To remove any gateway routes set the override to &ldquo;/&rdquo;. See the <a href=https://learn.microsoft.com/en-us/azure/application-gateway/configuration-http-settings#override-backend-path>docs</a> for more information.</p><p><strong>Override with new host name</strong> ensures that the App Service is able to accept a request in the first place. Since we cannot bind the same custom domain to multiple App Services, they must keep their <em>*.azurewebsites.net</em> (or different custom) domains. Any request with a different domain will be rejected. Therefore, the gateway must rewrite the domain.</p><blockquote><p>Make sure you are aware of the <a href=https://learn.microsoft.com/en-us/azure/architecture/best-practices/host-name-preservation>limitations</a> that come with overriding the host name. Don&rsquo;t use path based routes if these limitations affect your application.</p></blockquote><p><strong>Pick host name from backend target</strong> simply specifies in which domain the gateway should rewrite it. Most of the time, that&rsquo;ll be the very host name that is specified in the backend pool.</p><h5 id=rules---add-routing-rule>Rules -> Add routing rule</h5><p>Back in the rule form, scroll down to to the section &ldquo;Path based routing&rdquo;.
Here you have to add a path based rule for each App Service:</p><ul><li>path &ldquo;/service-a*&rdquo; routes to backend pool for App Service &ldquo;A&rdquo;</li><li>path &ldquo;/service-b*&rdquo; routes to backend pool for App Service &ldquo;B&rdquo;</li></ul><p>The backend target we set before automatically acts as the default route, so you don&rsquo;t have to add it as a path here.
If you don&rsquo;t want to handle requests without path, simply create an empty backend pool. Application Gateway will respond with HTTP status code 502 in this case.</p><p><img src=/img/appservice-appgw/gw-add-https-rule-paths.jpeg alt="Rule - all paths"></p><h5 id=redirection-to-https>Redirection to HTTPS</h5><p>If you want to redirect traffic from HTTP to HTTPS, add another rule with HTTP as protocol. In the section for backend targets, select &ldquo;Redirection&rdquo; as target type and set the listener that you created for HTTPS as target listener.</p><h4 id=final-steps>Final steps</h4><p>Your &ldquo;Configuration&rdquo; tab should now like this:</p><p><img src=/img/appservice-appgw/gw-final.jpeg alt=Rule></p><p>After you confirm the creation of the gateway, your final task is to add the public IP address of the gateway to the DNS entries for your domain.</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=https://janniklassahn.com/posts/iis-setup-for-spa/><span class=button__text>IIS configuration for Single Page Apps</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"></div></div></footer><script src=https://janniklassahn.com/assets/main.js></script>
<script src=https://janniklassahn.com/assets/prism.js></script></div></body></html>