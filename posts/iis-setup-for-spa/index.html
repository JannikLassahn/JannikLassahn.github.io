<!doctype html><html lang=en><head><title>IIS configuration for Single Page Apps — Jannik Lassahn</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A guide for setting up Internet Information Services (IIS) to serve a Single Page Application (SPA)"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://janniklassahn.com/posts/iis-setup-for-spa/><link rel=stylesheet href=https://janniklassahn.com/assets/style.css><link rel=stylesheet href=https://janniklassahn.com/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://janniklassahn.com/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://janniklassahn.com/img/favicon.png><link href=https://janniklassahn.com/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://janniklassahn.com/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://janniklassahn.com/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://janniklassahn.com/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://janniklassahn.com/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://janniklassahn.com/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="IIS configuration for Single Page Apps"><meta name=twitter:description content="A guide for setting up Internet Information Services (IIS) to serve a Single Page Application (SPA)"><meta property="og:title" content="IIS configuration for Single Page Apps"><meta property="og:description" content="A guide for setting up Internet Information Services (IIS) to serve a Single Page Application (SPA)"><meta property="og:type" content="article"><meta property="og:url" content="https://janniklassahn.com/posts/iis-setup-for-spa/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-02-04T00:00:00+00:00"><meta property="article:modified_time" content="2022-02-04T00:00:00+00:00"><style>body.dark-theme{--color:#dadadb}</style></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__text>Jannik Lassahn</span></a>
<span class=header__right><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>IIS configuration for Single Page Apps</h1><div class=post-meta><span class=post-date>04. Feb 2022</span></div><span class=post-tags><a href=https://janniklassahn.com/tags/iis/>#IIS</a>&nbsp;
<a href=https://janniklassahn.com/tags/spa/>#SPA</a>&nbsp;
<a href=https://janniklassahn.com/tags/router/>#router</a>&nbsp;
<a href=https://janniklassahn.com/tags/cache/>#cache</a>&nbsp;</span><div class=post-content><p>This is a short guide for setting up an Internet Information Services (IIS) site that serves a Single Page Application (SPA).</p><p>There are three obstacles to overcome here:</p><ol><li>How to serve a SPA with client-side routing</li><li>How to serve a non-cached, always up to date version of the SPA</li><li>How to prevent IIS from shutting down automatically</li></ol><p>Each problem will be addressed in this post, with additional information below the config. Here&rsquo;s the final web.config we will create:</p><div class=collapsable-code><input id=854219367 type=checkbox checked>
<label for=854219367><span class=collapsable-code__language>xml</span>
<span class=collapsable-code__title>web.config</span>
<span class=collapsable-code__toggle data-label-expand=Show data-label-collapse=Hide></span></label><pre class=language-xml><code>

&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
&lt;configuration&gt;
    &lt;system.webServer&gt;
        &lt;rewrite&gt;
            &lt;rules&gt;
                &lt;rule name=&#34;redirect to index&#34; stopProcessing=&#34;false&#34;&gt;
                    &lt;match url=&#34;.*&#34; /&gt;
                    &lt;conditions logicalGrouping=&#34;MatchAll&#34;&gt;
                        &lt;add input=&#34;{REQUEST_FILENAME}&#34; matchType=&#34;IsFile&#34; negate=&#34;true&#34; /&gt;
                        &lt;add input=&#34;{REQUEST_FILENAME}&#34; matchType=&#34;IsDirectory&#34; negate=&#34;true&#34; /&gt;
                    &lt;/conditions&gt;
                    &lt;action type=&#34;Rewrite&#34; url=&#34;/&#34; /&gt;
                &lt;/rule&gt;
            &lt;/rules&gt;
        &lt;/rewrite&gt;
    &lt;/system.webServer&gt;
    &lt;location path=&#34;index.html&#34;&gt;
        &lt;system.webServer&gt;
            &lt;httpProtocol&gt;
                &lt;customHeaders&gt;
                    &lt;add name=&#34;Cache-Control&#34; value=&#34;no-cache, no-store&#34; /&gt;
                &lt;/customHeaders&gt;
            &lt;/httpProtocol&gt;
        &lt;/system.webServer&gt;
  &lt;/location&gt;
&lt;/configuration&gt;
</code></pre></div><h2 id=serve-static-files>Serve static files</h2><p>In contrast to a pure static file server, we need IIS to always serve <code>index.html</code>, except for file requests that contain our JavaScript, CSS or other assets. This way we also support client-side routing.</p><p>First, install the <a href=https://www.iis.net/downloads/microsoft/url-rewrite>URL Rewrite</a> extension.
Then, add the file <code>web.config</code> to the folder that contains the SPA files (aka the folder with <code>index.html</code>). This <code>web.config</code> contains all the IIS settings for your site.
Simply add the necessary rewrite rules:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;configuration&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;system.webServer&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;rewrite&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;rules&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;rule</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;redirect to index&#34;</span> <span style=color:#a6e22e>stopProcessing=</span><span style=color:#e6db74>&#34;false&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;match</span> <span style=color:#a6e22e>url=</span><span style=color:#e6db74>&#34;.*&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;conditions</span> <span style=color:#a6e22e>logicalGrouping=</span><span style=color:#e6db74>&#34;MatchAll&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>&lt;add</span> <span style=color:#a6e22e>input=</span><span style=color:#e6db74>&#34;{REQUEST_FILENAME}&#34;</span> <span style=color:#a6e22e>matchType=</span><span style=color:#e6db74>&#34;IsFile&#34;</span> <span style=color:#a6e22e>negate=</span><span style=color:#e6db74>&#34;true&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>&lt;add</span> <span style=color:#a6e22e>input=</span><span style=color:#e6db74>&#34;{REQUEST_FILENAME}&#34;</span> <span style=color:#a6e22e>matchType=</span><span style=color:#e6db74>&#34;IsDirectory&#34;</span> <span style=color:#a6e22e>negate=</span><span style=color:#e6db74>&#34;true&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;/conditions&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;action</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#34;Rewrite&#34;</span> <span style=color:#a6e22e>url=</span><span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;/rule&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;/rules&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;/rewrite&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/system.webServer&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/configuration&gt;</span>
</span></span></code></pre></div><details><summary>See detailed explanation</summary><p>File servers generally serve only the files on disk, which means there is a 1:1 mapping between a file request from the browser and the file on disk on the server. A user visiting the root of our SPA will therefore see the site as expected, because all the static files like <code>index.html</code> and the referenced scripts and assets really exist on the server.</p><p>But when using client side routing, like Angular Router or React Router, you&rsquo;ll run into issues quickly.
Imagine you configured a route with the path <code>/products/:id</code> in your router. If the user visits a product with ID 1 directly (not from inside the app), IIS tries to find a file called <code>1</code> inside a folder <code>products</code>. However, this file will never exist, so IIS returns an error and the user will see the message <strong>404 - Not Found</strong>.</p><p>To fix this, we need IIS to return our <code>index.html</code> whenever we don&rsquo;t request an actual file or directory. The rewrite extension enables us to specify these exact rules with just a few lines of XML.</p></details><h2 id=keeping-users-up-to-date>Keeping users up to date</h2><p>The entrypoint to the app, <code>index.html</code>, should never be cached by the browser. Once you upload a new version to the server, all users with a cached version will either see no changes at all, a blank screen or errors.
To prevent any form of caching we add a header for <code>Cache-Control</code> with the value <code>no-cache, no-store</code> when serving <code>index.html</code>. All other files may be cached.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;configuration&gt;</span>
</span></span><span style=display:flex><span>    [...]
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;location</span> <span style=color:#a6e22e>path=</span><span style=color:#e6db74>&#34;index.html&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;system.webServer&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;httpProtocol&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;customHeaders&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;add</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;Cache-Control&#34;</span> <span style=color:#a6e22e>value=</span><span style=color:#e6db74>&#34;no-cache, no-store&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;/customHeaders&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;/httpProtocol&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;/system.webServer&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/location&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/configuration&gt;</span>
</span></span></code></pre></div><details><summary>Detailed explanation</summary><p>To explain this behavior, we must take a look at how build tools like <em>Angular CLI</em> and <em>Create React App</em> generate files :</p><blockquote><p>Each file inside of the build directory will have a unique hash appended to the filename that is generated based on the contents of the file, which allows you to use aggressive caching techniques to avoid the browser re-downloading your assets if the file contents haven&rsquo;t changed.
If the contents of a file changes in a subsequent build, the filename hash that is generated will be different.</p><p><strong>- <a href=https://create-react-app.dev/docs/production-build/>Create React App Docs</a></strong></p></blockquote><p>You can test this very easily on your own. Simply build your app, make changes to it and build again to a different folder afterwards. As you can see, updating the app results in a different set of files. Only <code>index.html</code> always keeps its name, but its contents reference the updated files. Remember: <code>index.html</code> is the entrypoint to your app. This file specifies all the scripts and styles necessary to kickoff rendering the whole site.</p><p>Imagine a user visited your site and as a result now has the following files cached locally:</p><ul><li><code>index.html</code></li><li><code>main.aaa.js</code></li><li><code>styles.111.css</code></li></ul><p>After a while, you publish another version with updated styles and bug fixes. Let&rsquo;s assume the build tool produces these files:</p><ul><li><code>index.html</code></li><li><code>main.bbb.js</code></li><li><code>styles.222.css</code></li></ul><p>Now, since the users browser (or some proxy server) has no way of telling when the cached file is outdated this user is stuck on the older version. Adding the cache-control header to your config as seen above forces the browser to never cache <code>index.html</code> and always request it from the server. And because <code>index.html</code> references all other hashed files the browser will load them as well. As a result, the user will always have the newest version of your app.</p><p>As mentioned above, all hashed files can even be cached indefinitely. At some point, the users browser could have cached multiple versions of our app, like so:</p><ul><li><code>index.html</code></li><li><code>main.aaa.js</code> (cached, not used)</li><li><code>main.bbb.js</code> (cached)</li><li><code>styles.111.css</code> (cached, not used)</li><li><code>styles.222.css</code> (cached)</li></ul><p>Luckily, we&rsquo;re now using our hashed files the right way and don&rsquo;t really care what else the browser stored in the past.</p><p>IIS already sends lots of useful headers out of the box: you&rsquo;ll notice the headers <em>Date</em>, <em>Last-Modified</em>, and <em>ETag</em> when debugging requests. Browsers perform a lot of &ldquo;guess work&rdquo; when we don&rsquo;t exactly specify how to cache things, so expect different behavior depending on the vendor and version.
If you want to know more about caching concepts in general I recommend <a href=https://web.dev/http-cache/>this web.dev article</a>.</p></details><h2 id=prevent-iis-from-shutting-down>Prevent IIS from shutting down</h2><p>If you require your site to be available at all times, then these settings could help you deliver consistent response times.
To be clear, the site or IIS itself can&rsquo;t shut down automatically. The worker processes that manage the requests, however, can. That&rsquo;s why we have to adjust these settings in the IIS manager:</p><p><img src=/img/IIS_application_pool_settings.png alt="IIS application pool settings"></p><p>First, select the <em>application pool</em> for your site, then open the advanced settings.</p><p><strong>Idle Time-out</strong></p><p>Setting <em>Idle Time-out</em> to <em>0</em> might already be enough for your use case. The default setting is <em>20</em>, which means that IIS would kill the worker process after 20 minutes of inactivity to free resources. Setting it to <em>0</em> ensures that IIS keeps the process around to instantly handle incoming requests.</p><p><strong>Start mode</strong></p><p>To make sure a worker process is available to begin with, you can also set <em>Start mode</em> to <em>AlwaysRunning</em>. The default setting is <em>OnDemand</em>, which means a worker process is only created once the very first request to the site is received. With <em>AlwaysRunning</em> the process is created right away, which further reduces initial response times.</p><p>As always, try to profile your system to understand which settings provide the best balance between availability and total resource load.</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://janniklassahn.com/posts/gateway-app-service-routing/><span class=button__icon>←</span>
<span class=button__text>Azure App Service routing using Application Gateway</span></a></span>
<span class="button next"><a href=https://janniklassahn.com/posts/vuforia-uwp-external-camera/><span class=button__text>Integrating external cameras in Vuforia UWP apps</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"></div></div></footer><script src=https://janniklassahn.com/assets/main.js></script>
<script src=https://janniklassahn.com/assets/prism.js></script></div></body></html>